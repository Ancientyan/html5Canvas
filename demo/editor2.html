<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>text editor</title>
    <style>
      body {
        margin: 0;
      }
      #board {
        position: relative;
        width: 600px;
      }
      textarea {
        z-index: -1;
        box-sizing: border-box;
        position: absolute;
        left: 0;
        top: 0;
        padding: 4px;
        font-size: 15px;
        resize: none;
        outline: none;
      }
      #cursor {
        position: absolute;
        top: -1;
        left: -1;
        height: 20px;
        border-right: 1px solid hsl(0, 0%, 20%);
        animation: flash 1s linear 0.5s infinite;
        animation-fill-mode: both;
      }
      @keyframes flash {
        from {
          border-color: hsl(0, 0%, 95%);
        }
        to {
          border-color: hsl(0, 100%, 20%);
        }
      }
    </style>
  </head>
  <body>
    <div id="board">
      <canvas id="canvas" width="600" height="400"></canvas>
      <textarea name="input" id="input" cols="10" rows="1"></textarea>
      <div id="cursor"></div>
    </div>
    <script src="../../graphics/util.js"></script>
    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const ratio = 2;
      const w = canvas.width * ratio;
      const h = canvas.height * ratio;
      const bgStyle = "hsl(0,0%,97%)";

      setPixelRatio(canvas, ratio);
      ctx.fillStyle = bgStyle;
      ctx.fillRect(0, 0, w, h);

      ctx.fillStyle = "hsl(0,0%,30%)";
      ctx.font = "30px arial";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      
      // 计算包含emoji的字符串长度
      function charCount(str) {
        const reg = /\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDE4F]/g;
        return str.replace(reg, "a").length;
      }

      class Cursor {
        constructor(elem) {
          this.x = -2;
          this.y = -2;
          this.dom = elem;
          this.w = ctx.measureText("你").width;
          this.dom.style.height = this.w / 2 + "px";
        }
        init() {
          this.move(-2, -2);
        }
        move(x, y) {
          this.x = x;
          this.y = y;
          this.dom.style.left = x / 2 + "px";
          this.dom.style.top = y / 2 - this.w / 3 + "px";
        }
      }

      class TextLine {
        constructor(elem) {
          this.x = 0;
          this.y = 0;
          this.input = elem;
          this.w = ctx.measureText("你").width * 2;
          this.init();
          return this;
        }
        init() {
          this.input.value = "";
          setTimeout(() => {
            this.input.focus();
          }, 500);
          this.txts = "";
          this.index = 0;
          return this;
        }
        move(x, y) {
          this.x = x;
          this.y = y;
          return this;
        }
        setIndex(i) {
          return (this.index = Math.min(
            Math.max(this.index + i, 0),
            charCount(this.txts)
          ));
        }
        getWidth(i) {
          let txt = "";
          if (i === undefined) {
            txt = this.txts.slice(0);
          } else {
            // for...of 遍历字符串解决 emoji 定位
            let l = i < 0 ? charCount(this.txts) + i : i;
            for (let x of this.txts) {
              if (!l) break;
              txt += x;
              l--;
            }
          }
          return ctx.measureText(txt).width;
        }
        insert(str) {
          this.txts = str;
          return this;
        }
        draw(str, s) {
          ctx.save();
          ctx.fillText(str, this.x + s, this.y);
          ctx.restore();
          return this;
        }
        erase(s, l) {
          ctx.save();
          ctx.fillStyle = bgStyle;
          ctx.fillRect(this.x + s, this.y - this.w / 2, l, this.w);
          ctx.restore();
          return this;
        }
      }

      const cursor = new Cursor(document.getElementById("cursor"));
      const line = new TextLine(document.getElementById("input"));
      canvas.onmousedown = function(e) {
        const pos = windowToCanvas(canvas, e.clientX, e.clientY);
        line.init().move(pos.x, pos.y);
        cursor.move(pos.x, pos.y);
      };

      line.input.oninput = function(e) {
        const str = e.target.value;
        const ostr = line.txts;
        //清除旧值再重写新值
        line.erase(0, line.getWidth() + 2);
        line.insert(str).draw(str, 0);
        const i = line.setIndex(charCount(str) - charCount(ostr));
        cursor.move(line.x + line.getWidth(i), line.y);
      };

      document.onkeydown = function(e) {
        // left
        if (e.keyCode === 37) {
          const i = line.setIndex(-1);
          cursor.move(line.x + line.getWidth(i), line.y);
        }
        // right
        if (e.keyCode === 39) {
          const i = line.setIndex(1);
          cursor.move(line.x + line.getWidth(i), line.y);
        }
      };
    </script>
  </body>
</html>
